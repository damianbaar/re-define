(function (parent, factory){
  if (typeof define === 'function' && define.amd) {
    define('{{{config.name}}}', [{{{chain external map '\'|\'' reduce}}}], factory)
  } else if (typeof exports === 'object') {
  module.exports = factory({{{chain external map 'require(\'|\')' reduce}}})
  } else {
    {{#each external}}var {{{escape this}}} = {{{global this}}}
    {{/each}}
    {{#if config.returns}}parent['{{{config.name}}}'] = {{/if}}factory({{{chain external escape}}})
  }
  }(this, function ({{{chain external escape}}}) {
  {{{chain external escape map 'this.| = |'}}}

  {{#each bundles}}
  {{#if this.wrap}} 
  this['{{{this.name}}}'] = (function() {
    var __context = this
    var {{{../../config.scopeVar}}} = {}
    {{{this.code}}}
    return {{{../../config.scopeVar}}}['{{{this.returns}}}']

    function {{{../../config.internalRequire}}} (name) { return __context[name] || {{{../../config.scopeVar}}}[name] }
    })
    .call(this);
  {{else}} {{{this.code}}} {{/if}} {{/each}}

  {{#if config.returns }} return this['{{{config.returns}}}'] {{/if}}
  }.bind({})))
